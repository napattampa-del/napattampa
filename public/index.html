<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMCR Analytics - Vintage Edition</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-paper: #f4e4bc; /* Cream/Aged Paper */
            --ink-color: #2c2c2c; /* Charcoal Ink */
            --accent-red: #8b0000; /* Dark Red */
            --accent-blue: #192a56; /* Vintage Navy */
            --border-style: 3px double var(--ink-color); /* Double Line Border */
        }

        body { 
            margin: 0; padding: 0; 
            font-family: 'Cormorant Garamond', serif; 
            background-color: var(--bg-paper);
            color: var(--ink-color);
            overflow: hidden;
            /* Texture Effect: Subtle noise */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }
        
        h1, h2, h3, h4 {
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            margin: 0;
        }

        /* --- HEADER --- */
        #header {
            height: 80px;
            background-color: var(--bg-paper);
            border-bottom: var(--border-style);
            display: flex; align-items: center; padding: 0 40px; gap: 40px;
            position: relative;
            z-index: 1000;
            /* Decorative Top Line */
            box-shadow: inset 0 5px 0 0 var(--ink-color); 
        }

        .brand-group {
            display: flex; flex-direction: column;
            margin-right: auto;
            border: 2px solid var(--ink-color);
            padding: 5px 15px;
        }
        
        .brand-group h3 { font-size: 22px; color: var(--ink-color); line-height: 1; }
        .credit-text {
            font-size: 10px; color: var(--accent-red); font-style: italic; 
            font-family: 'Cinzel', serif; margin-top: 2px; text-align: center;
        }
        
        /* --- NAV TABS (Classic Menu Style) --- */
        .nav-tabs { display: flex; gap: 0; border: 1px solid var(--ink-color); }
        .nav-tab {
            padding: 10px 25px; 
            cursor: pointer; font-size: 14px; font-weight: 700; 
            color: var(--ink-color);
            background: transparent;
            border-right: 1px solid var(--ink-color);
            transition: all 0.2s;
            font-family: 'Cinzel', serif;
        }
        .nav-tab:last-child { border-right: none; }
        .nav-tab:hover { background: rgba(0,0,0,0.05); }
        .nav-tab.active { 
            background: var(--ink-color); 
            color: var(--bg-paper); 
        }

        /* --- CONTROLS --- */
        .control-group label { 
            font-size: 11px; color: var(--accent-blue); 
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            font-family: 'Cinzel', serif;
        }
        select { 
            padding: 5px 10px; 
            border: 2px solid var(--ink-color); 
            border-radius: 0; /* Sharp Edges */
            background: transparent; 
            font-family: 'Cormorant Garamond', serif; 
            font-weight: 600; font-size: 16px;
            color: var(--ink-color); cursor: pointer;
            min-width: 150px;
        }
        select:focus { outline: 2px solid var(--accent-red); }

        /* --- LAYOUT --- */
        .view-container { display: none; height: calc(100vh - 83px); width: 100%; }
        .view-container.active { display: flex; }

        #map-container { flex: 7; height: 100%; position: relative; border-right: var(--border-style); }
        
        /* Map Filter to look vintage */
        #map { height: 100%; width: 100%; z-index: 1; filter: sepia(40%) contrast(90%); }
        
        #sidebar { 
            flex: 3; height: 100%; background: var(--bg-paper);
            overflow-y: auto; padding: 20px; box-sizing: border-box; 
            display: flex; flex-direction: column; gap: 20px;
            /* Subtle Hatching Pattern Background */
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.02) 10px, rgba(0,0,0,0.02) 11px);
        }

        /* --- CARDS (Engraved Frame) --- */
        .card, .summary-col { 
            background: var(--bg-paper); 
            border: 2px solid var(--ink-color); 
            padding: 15px; position: relative;
            /* Corner decorations */
            outline: 1px solid var(--ink-color);
            outline-offset: -5px;
        }
        .card h3, .summary-col h3 { 
            font-size: 18px; color: var(--ink-color); 
            text-align: center; border-bottom: 1px solid var(--ink-color); 
            padding-bottom: 10px; margin-bottom: 15px;
        }
        /* Decorative symbol under title */
        .card h3::after, .summary-col h3::after {
            content: "✦"; display: block; font-size: 12px; margin-top: 5px; color: var(--accent-red);
        }

        /* --- SUMMARY LAYOUT --- */
        #summary-view { flex-direction: column; padding: 30px; overflow-y: auto; box-sizing: border-box; gap: 30px; }
        .summary-row { display: flex; gap: 30px; height: 48%; min-height: 400px; }
        .summary-col { flex: 1; display: flex; flex-direction: column; }

        .chart-wrapper { flex: 1; position: relative; width: 100%; min-height: 200px; }

        /* --- DEPTH CONTROLS (Vintage Tag) --- */
        #depth-controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background-color: var(--bg-paper);
            padding: 5px 20px; 
            border: 2px solid var(--ink-color);
            display: flex; align-items: center; gap: 15px;
            box-shadow: 3px 3px 0 var(--ink-color);
        }
        .nav-btn { cursor: pointer; font-size: 20px; color: var(--ink-color); font-weight: bold; }
        .nav-btn:hover { color: var(--accent-red); }
        .depth-title { font-family: 'Cinzel', serif; font-size: 14px; font-weight: 700; }
        .depth-subtitle { font-size: 12px; font-style: italic; letter-spacing: 1px; }

        /* --- TABLES (Grid Layout) --- */
        .corr-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: center; border: 2px solid var(--ink-color); }
        .corr-table th { 
            background: var(--ink-color); color: var(--bg-paper); 
            font-family: 'Cinzel', serif; padding: 8px; border: 1px solid var(--bg-paper);
        }
        .corr-table td { padding: 6px; border: 1px solid var(--ink-color); font-weight: 600; }
        .corr-cell { cursor: pointer; transition: 0.2s; }
        .corr-cell:hover { background-color: var(--accent-red) !important; color: white !important; }
        .corr-cell.active { box-shadow: inset 0 0 0 2px var(--accent-blue); }

        /* --- LEGEND (Engraving Style) --- */
        .legend { 
            background: var(--bg-paper); padding: 10px; border: 2px solid var(--ink-color); 
            font-size: 12px; width: 160px; font-family: 'Cormorant Garamond', serif; font-weight: 600;
            outline: 1px solid var(--ink-color); outline-offset: -3px;
        }
        .legend h4 { margin-bottom: 5px; font-family: 'Cinzel', serif; text-align: center; font-size: 12px;}
        /* Hatching pattern for gradient */
        .legend-gradient-bar { 
            height: 10px; width: 100%; 
            background: linear-gradient(to right, #fff, var(--ink-color)); 
            border: 1px solid var(--ink-color); margin-bottom: 5px; 
        }
        .legend-labels { display: flex; justify-content: space-between; font-style: italic;}

        .close-btn { position: absolute; top: 5px; right: 10px; font-size: 24px; cursor: pointer; color: var(--accent-red); font-family: 'Cinzel';}
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0; border: 1px solid var(--ink-color); }
        .stat-box { padding: 10px 0; border-right: 1px solid var(--ink-color); background: rgba(0,0,0,0.02); }
        .stat-box:last-child { border-right: none; }
        .stat-val { font-size: 22px; font-weight: 700; color: var(--ink-color); font-family: 'Cinzel', serif; }
        .stat-label { font-size: 11px; color: var(--accent-blue); text-transform: uppercase; margin-top: 2px; }
    </style>
</head>
<body>

    <div id="header">
        <div class="brand-group">
            <h3>DMCR Analytics</h3>
            <span class="credit-text">Est. 2025 by nptppnm</span>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchView('map')">Map View</div>
            <div class="nav-tab" onclick="switchView('summary')">Report</div>
        </div>

        <div class="control-group" id="cruise-control-group" style="display:none;">
            <label>Cruise Selection</label>
            <select id="cruiseSelect">
                <option value="all">All Cruises</option>
                <option value="GoT">Gulf of Thailand</option>
                <option value="River">River Data</option>
            </select>
        </div>

        <div class="control-group" id="time-control-group">
            <label>Time Period</label>
            <select id="timeSelect"><option value="">Loading...</option></select>
        </div>

        <div class="control-group">
            <label>Parameter</label>
            <select id="paramSelect">
                <option value="do_ctd_mg_l">Dissolved Oxygen</option>
                <option value="salinity_ctd_psu">Salinity</option>
                <option value="water_temperature_ctd_c">Temperature</option>
                <option value="chl_a_ctd_ug_l">Chlorophyll-a</option>
                <option value="nitrate_um">Nitrate (NO3)</option>
                <option value="phosphate_um">Phosphate (PO4)</option>
                <option value="tss_mg_l">TSS</option>
            </select>
        </div>
    </div>

    <div id="map-view" class="view-container active">
        <div id="map-container">
            <div id="map"></div>
            <div id="depth-controls">
                <div class="nav-btn" onclick="changeDepth(-1)">&#9664;</div> <div class="depth-label-container">
                    <span class="depth-title" id="depth-title">All Depths</span>
                    <span class="depth-subtitle" id="depth-subtitle">Average Value</span>
                </div>
                <div class="nav-btn" onclick="changeDepth(1)">&#9654;</div>
            </div>
        </div>
        
        <div id="sidebar">
            <div class="card">
                <h3>Statistics <span style="font-size:12px; font-weight:400; font-style:italic;" id="stats-subtitle"></span></h3>
                <div id="stats-content"><p style="text-align:center; font-style:italic;">No Data Selected</p></div>
            </div>
            <div id="overview-panel">
                <div class="card">
                    <h3>Average Profile</h3>
                    <div class="chart-wrapper"><canvas id="avgProfileChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>Distribution</h3>
                    <div class="chart-wrapper"><canvas id="scatterChart"></canvas></div>
                </div>
            </div>
            <div class="card" id="station-panel" style="display:none;">
                <span class="close-btn" onclick="closeStationView()">✕</span>
                <h3>Station Profile</h3>
                <p id="station-info" style="font-size:14px; text-align:center; margin-bottom:15px; font-weight:bold;"></p>
                <div class="chart-wrapper" style="height:250px;"><canvas id="stationChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="summary-view" class="view-container">
        <div class="summary-row">
            <div class="summary-col">
                <h3>Station Ranking</h3>
                <div class="chart-wrapper"><canvas id="rankStationChart"></canvas></div>
            </div>
            <div class="summary-col">
                <h3>Yearly Trends</h3>
                <div class="chart-wrapper"><canvas id="rankYearChart"></canvas></div>
            </div>
        </div>
        
        <div class="summary-row" style="flex:1;">
            <div class="summary-col" style="flex:1; overflow:hidden;">
                <h3>Correlation Matrix</h3>
                <div style="overflow:auto; height:100%;" id="correlation-container"><p style="text-align:center; margin-top:50px;">Loading Matrix...</p></div>
            </div>
            <div class="summary-col" style="flex:1;">
                <h3 id="corr-chart-title">Relationship</h3>
                <div class="chart-wrapper"><canvas id="corrScatterChart"></canvas></div>
                <p style="font-size:12px; text-align:center; margin-top:10px; font-style:italic;">Select a cell to analyze details.</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- VINTAGE CHART CONFIG ---
        // Using "Ink" colors and serif fonts
        Chart.defaults.font.family = "'Cormorant Garamond', serif";
        Chart.defaults.font.size = 14;
        Chart.defaults.color = '#2c2c2c';
        const vintageColors = {
            ink: '#2c2c2c',
            red: '#8b0000',
            blue: '#192a56',
            paper: '#f4e4bc'
        };

        const map = L.map('map').setView([13.0, 100.5], 6);
        // Using CartoDB Light but styling it with CSS filter to look aged
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
            attribution: '&copy; CARTO' 
        }).addTo(map);
        
        const markersLayer = L.featureGroup().addTo(map);
        let legendControl = L.control({position: 'bottomright'});
        
        let allData = [];
        let globalParamLimits = null;
        let correlationData = null;
        
        let stationChart=null, avgProfileChart=null, scatterChart=null;
        let rankStationChart=null, rankYearChart=null, corrScatterChart=null;

        let currentDepthIndex = 0;
        const depthLevels = [
            { id: 'all', dbValue: null, title: 'ALL DEPTHS', subtitle: 'Average Value' },
            { id: 'surface', dbValue: 'S', title: 'SURFACE', subtitle: 'Depth ~ 0-1m' },
            { id: 'mid', dbValue: 'M', title: 'MID-WATER', subtitle: 'Mid Depth' },
            { id: 'bottom', dbValue: 'B', title: 'BOTTOM', subtitle: 'Seabed' }
        ];
        const levelMap = { 'S': 'Surface', 'M': 'Mid-Water', 'B': 'Bottom' };
        const yLabelsOrder = ['Surface', 'Mid-Water', 'Bottom'];
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        const paramNames = {
            'do_ctd_mg_l': 'DO', 'salinity_ctd_psu': 'Salinity',
            'water_temperature_ctd_c': 'Temp', 'chl_a_ctd_ug_l': 'Chl-a',
            'nitrate_um': 'NO3', 'phosphate_um': 'PO4', 'tss_mg_l': 'TSS'
        };
        const paramsList = Object.keys(paramNames);

        async function initApp() {
            await Promise.all([initDropdown(), fetchGlobalStats()]);
            const initialTime = document.getElementById('timeSelect').value;
            if(initialTime) { const [y, m] = initialTime.split('-'); loadMapData(y, m); }
        }

        async function initDropdown() {
            try {
                const res = await fetch('/api/available-months');
                const data = await res.json();
                const select = document.getElementById('timeSelect');
                select.innerHTML = '';
                data.forEach(item => {
                    const value = `${item.year}-${item.month}`;
                    const text = `${item.year} - ${monthNames[item.month - 1]}`;
                    select.innerHTML += `<option value="${value}">${text}</option>`;
                });
            } catch (e) { console.error(e); }
        }

        async function fetchGlobalStats() {
            try {
                const res = await fetch('/api/global-stats');
                globalParamLimits = await res.json();
            } catch (e) { console.error(e); }
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            
            const timeCtrl = document.getElementById('time-control-group');
            const cruiseCtrl = document.getElementById('cruise-control-group');

            if (viewName === 'map') {
                document.getElementById('map-view').classList.add('active');
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
                timeCtrl.style.display = 'flex';
                cruiseCtrl.style.display = 'none';
                setTimeout(() => map.invalidateSize(), 100);
            } else {
                document.getElementById('summary-view').classList.add('active');
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
                timeCtrl.style.display = 'none';
                cruiseCtrl.style.display = 'flex';
                loadSummaryData();
            }
        }

        function loadMapData(year, month) {
            let url = `/api/stations?year=${year}&month=${month}`;
            fetch(url).then(res => res.json()).then(data => {
                allData = data;
                renderMapByDepth();
                renderOverviewCharts();
            });
        }

        function changeDepth(dir) {
            currentDepthIndex += dir;
            if (currentDepthIndex >= depthLevels.length) currentDepthIndex = 0;
            if (currentDepthIndex < 0) currentDepthIndex = depthLevels.length - 1;
            const current = depthLevels[currentDepthIndex];
            document.getElementById('depth-title').innerText = current.title;
            document.getElementById('depth-subtitle').innerText = current.subtitle;
            renderMapByDepth();
        }

        function getColor(value, min, max) {
            if (value === null || value === undefined) return '#a0a0a0';
            if (max === min) return '#555';
            const ratio = (value - min) / (max - min);
            // Monochrome / Ink Scale
            if (ratio > 0.8) return '#000000'; // Pure Ink
            if (ratio > 0.6) return '#2c2c2c'; 
            if (ratio > 0.4) return '#595959'; 
            if (ratio > 0.2) return '#8c8c8c'; 
            return '#bfbfbf'; // Light Gray
        }

        function renderMapByDepth() {
            markersLayer.clearLayers();
            const currentLevel = depthLevels[currentDepthIndex];
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;

            let displayData = [];
            if (currentLevel.dbValue === null) {
                const stations = {};
                allData.forEach(d => {
                    if (!stations[d.station]) stations[d.station] = { lat: d.lat, lon: d.lon, station: d.station, sampling_level: 'Average', values: [] };
                    if (d[param] !== null) stations[d.station].values.push(d[param]);
                });
                displayData = Object.values(stations).map(s => {
                    const avg = s.values.length > 0 ? s.values.reduce((a,b)=>a+b,0)/s.values.length : null;
                    return { ...s, [param]: avg };
                });
            } else {
                displayData = allData.filter(d => d.sampling_level && d.sampling_level.trim() === currentLevel.dbValue);
            }

            let minVal = 0, maxVal = 0;
            if (globalParamLimits) {
                minVal = globalParamLimits[`min_${param}`];
                maxVal = globalParamLimits[`max_${param}`];
            } else {
                const vals = displayData.map(d => d[param]).filter(v => v !== null);
                minVal = Math.min(...vals); maxVal = Math.max(...vals);
            }

            updateStats(displayData, param, currentLevel.title, minVal, maxVal);
            updateLegend(minVal, maxVal, paramName);

            const drawn = new Set();
            displayData.forEach(point => {
                const val = point[param];
                if (val !== null && val !== undefined) {
                    if (currentLevel.dbValue !== null) {
                        if (drawn.has(point.station)) return;
                        drawn.add(point.station);
                    }
                    const color = getColor(val, minVal, maxVal);
                    // Circle Marker with heavy border to look like ink
                    const marker = L.circleMarker([point.lat, point.lon], { 
                        radius: 6, 
                        fillColor: color, 
                        color: "#000", 
                        weight: 2, 
                        opacity: 1, 
                        fillOpacity: 1 
                    });
                    marker.bindPopup(`<div style="text-align:center; font-family:'Cormorant Garamond'"><b>${point.station}</b><br><span style="font-size:12px;">${point.sampling_level}</span><br>${paramName}: <b>${val.toFixed(2)}</b></div>`);
                    marker.on('click', () => renderStationProfile(point.station));
                    markersLayer.addLayer(marker);
                }
            });
            if (markersLayer.getLayers().length > 0) map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
        }

        function updateStats(data, param, levelTitle, minV, maxV) {
            const vals = data.map(d => d[param]).filter(v => v !== null);
            document.getElementById('stats-subtitle').innerText = `(${levelTitle})`;
            if (vals.length === 0) { document.getElementById('stats-content').innerHTML = "No Data"; return; }
            const min = Math.min(...vals).toFixed(2);
            const max = Math.max(...vals).toFixed(2);
            const avg = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
            document.getElementById('stats-content').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-val">${min}</div><div class="stat-label">Min</div></div>
                    <div class="stat-box"><div class="stat-val">${avg}</div><div class="stat-label">Avg</div></div>
                    <div class="stat-box"><div class="stat-val">${max}</div><div class="stat-label">Max</div></div>
                </div>`;
        }

        function updateLegend(min, max, name) {
            if (legendControl) map.removeControl(legendControl);
            legendControl = L.control({position: 'bottomright'});
            legendControl.onAdd = function () {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `<h4>${name}</h4><div class="legend-gradient-bar"></div>
                <div class="legend-labels"><span>${min.toFixed(2)}</span><span>${max.toFixed(2)}</span></div>
                <div style="font-size:10px;text-align:center;margin-top:2px;">Global Range</div>`;
                return div;
            };
            legendControl.addTo(map);
        }

        function loadSummaryData() {
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;
            const cruise = document.getElementById('cruiseSelect').value;

            fetch(`/api/summary/rankings?param=${param}&cruise=${cruise}`)
                .then(res => res.json())
                .then(data => { renderRankingCharts(data.stations, data.years, paramName); });

            fetch(`/api/summary/correlation-data?cruise=${cruise}`)
                .then(res => res.json())
                .then(data => {
                    correlationData = data;
                    renderCorrelationMatrix(data);
                    updateCorrScatterChart(paramsList[0], paramsList[1]);
                });
        }

        // --- CHARTS STYLING: MONOCHROME/VINTAGE ---
        function renderRankingCharts(stations, years, paramName) {
            const sortedStations = stations.sort((a,b) => b.avg_val - a.avg_val);
            const displaySt = sortedStations.slice(0, 10);
            
            const ctxSt = document.getElementById('rankStationChart').getContext('2d');
            if (rankStationChart) rankStationChart.destroy();
            rankStationChart = new Chart(ctxSt, {
                type: 'bar',
                data: {
                    labels: displaySt.map(d => d.station),
                    datasets: [{
                        label: `Avg ${paramName}`,
                        data: displaySt.map(d => d.avg_val),
                        backgroundColor: vintageColors.ink,
                        borderColor: vintageColors.ink,
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });

            const sortedYears = years.sort((a,b) => a.year - b.year);
            const ctxYr = document.getElementById('rankYearChart').getContext('2d');
            if (rankYearChart) rankYearChart.destroy();
            rankYearChart = new Chart(ctxYr, {
                type: 'bar',
                data: {
                    labels: sortedYears.map(d => d.year),
                    datasets: [{
                        label: `Avg ${paramName}`,
                        data: sortedYears.map(d => d.avg_val),
                        backgroundColor: vintageColors.blue, // Navy for years
                        borderColor: vintageColors.ink,
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderCorrelationMatrix(data) {
            if (!data || data.length === 0) { document.getElementById('correlation-container').innerHTML = "<p>No Data</p>"; return; }
            const shortNames = paramsList.map(k => paramNames[k]);
            const calcCorr = (keyX, keyY) => {
                const n = data.length;
                let sumX=0, sumY=0, sumXY=0, sumX2=0, sumY2=0, count=0;
                for(let i=0; i<n; i++) {
                    const x = data[i][keyX], y = data[i][keyY];
                    if(x!==null && y!==null) { sumX+=x; sumY+=y; sumXY+=x*y; sumX2+=x*x; sumY2+=y*y; count++; }
                }
                if (count === 0) return 0;
                const num = (count * sumXY) - (sumX * sumY);
                const den = Math.sqrt((count * sumX2 - sumX*sumX) * (count * sumY2 - sumY*sumY));
                return den === 0 ? 0 : num / den;
            };

            let html = '<table class="corr-table"><thead><tr><th></th>';
            shortNames.forEach(n => html += `<th>${n}</th>`);
            html += '</tr></thead><tbody>';

            paramsList.forEach((p1, i) => {
                html += `<tr><th>${shortNames[i]}</th>`;
                paramsList.forEach((p2, j) => {
                    if (i === j) html += '<td style="background:#ddd;">1.0</td>';
                    else {
                        const r = calcCorr(p1, p2);
                        let bg = 'transparent';
                        let textColor = 'black';
                        // Style correlation like heat intensity map (Monochrome/Red)
                        if(r > 0) {
                            bg = `rgba(44, 44, 44, ${Math.abs(r)})`; // Black for positive
                            if(Math.abs(r)>0.5) textColor = 'white';
                        } else {
                            bg = `rgba(139, 0, 0, ${Math.abs(r)})`; // Dark Red for negative
                            if(Math.abs(r)>0.5) textColor = 'white';
                        }
                        
                        html += `<td class="corr-cell" onclick="updateCorrScatterChart('${p1}', '${p2}', this)" style="background:${bg}; color:${textColor}">${r.toFixed(2)}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('correlation-container').innerHTML = html;
        }

        function calculateLinearRegression(data) {
            const n = data.length;
            if (n === 0) return { m: 0, b: 0, r2: 0 };
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, sumYY = 0;
            data.forEach(p => { sumX += p.x; sumY += p.y; sumXY += p.x * p.y; sumXX += p.x * p.x; sumYY += p.y * p.y; });
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const num = (n * sumXY - sumX * sumY);
            const den = Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
            const r = den === 0 ? 0 : num / den;
            return { m: slope, b: intercept, r2: r * r };
        }

        function updateCorrScatterChart(xKey, yKey, cellElement) {
            document.querySelectorAll('.corr-cell').forEach(el => el.classList.remove('active'));
            if(cellElement) cellElement.classList.add('active');
            const xName = paramNames[xKey], yName = paramNames[yKey];
            const dataPoints = correlationData.filter(d => d[xKey]!==null && d[yKey]!==null).map(d => ({ x: d[xKey], y: d[yKey] }));
            const reg = calculateLinearRegression(dataPoints);
            const minX = Math.min(...dataPoints.map(d => d.x)), maxX = Math.max(...dataPoints.map(d => d.x));
            const trendData = [{ x: minX, y: reg.m * minX + reg.b }, { x: maxX, y: reg.m * maxX + reg.b }];

            document.getElementById('corr-chart-title').innerHTML = `RELATIONSHIP: ${xName} vs ${yName} <span style="font-size:12px; font-weight:400;">(R²=${reg.r2.toFixed(3)})</span>`;
            const ctx = document.getElementById('corrScatterChart').getContext('2d');
            if (corrScatterChart) corrScatterChart.destroy();
            corrScatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Data', data: dataPoints, backgroundColor: 'rgba(44, 44, 44, 0.3)', pointRadius: 2 },
                        { label: 'Trend', data: trendData, type: 'line', borderColor: vintageColors.red, borderWidth: 2, pointRadius: 0, fill: false, tension:0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: xName } }, y: { title: { display: true, text: yName } } } }
            });
        }

        function renderOverviewCharts() {
            document.getElementById('overview-panel').style.display = 'block';
            document.getElementById('station-panel').style.display = 'none';
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;

            const calcAvg = (lvl) => {
                const grp = allData.filter(d => d.sampling_level === lvl && d[param] !== null);
                if(grp.length === 0) return null;
                return grp.reduce((a,b)=>a+b[param],0)/grp.length;
            };
            const lineData = [];
            ['S','M','B'].forEach((l, i) => {
                const val = calcAvg(l);
                if(val!==null) lineData.push({x: val, y: yLabelsOrder[i]});
            });

            const ctxAvg = document.getElementById('avgProfileChart').getContext('2d');
            if (avgProfileChart) avgProfileChart.destroy();
            avgProfileChart = new Chart(ctxAvg, {
                type: 'line',
                data: { labels: yLabelsOrder, datasets: [{ label: 'Average Profile', data: lineData, borderColor: vintageColors.ink, borderDash: [5,5], backgroundColor: 'transparent', tension: 0, pointRadius:6, pointBackgroundColor: vintageColors.ink }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { reverse: true, type:'category' }, x:{title:{display:true,text:paramName}} } }
            });

            const scatterData = allData.filter(d => d[param]!==null && d.sampling_depth_m!==null).map(d => ({x:d[param], y:d.sampling_depth_m}));
            const ctxScat = document.getElementById('scatterChart').getContext('2d');
            if (scatterChart) scatterChart.destroy();
            scatterChart = new Chart(ctxScat, {
                type: 'scatter',
                data: { datasets: [{ label: 'All Data', data: scatterData, backgroundColor: 'rgba(44, 44, 44, 0.5)', pointRadius:2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { reverse: true, title:{display:true, text:'Depth (m)'} }, x:{title:{display:true,text:paramName}} } }
            });
        }

        function renderStationProfile(stationName) {
            document.getElementById('overview-panel').style.display = 'none';
            document.getElementById('station-panel').style.display = 'block';
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;
            const sData = allData.filter(d => d.station===stationName && d[param]!==null);
            
            const ctx = document.getElementById('stationChart').getContext('2d');
            if(stationChart) stationChart.destroy();
            stationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yLabelsOrder,
                    datasets: [{ label: stationName, data: sData.map(d=>({x:d[param], y:levelMap[d.sampling_level]||d.sampling_level})), borderColor: vintageColors.blue, tension:0, fill:false, pointBackgroundColor: '#fff', pointBorderColor: vintageColors.blue, pointRadius: 5 }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { type: 'category', reverse: true, title: { display: true, text: 'Level' } }, x:{title:{display:true,text:paramName}} } }
            });
            document.getElementById('station-info').innerHTML = `STATION: <b>${stationName}</b> | ${paramName}`;
        }

        function closeStationView() { renderOverviewCharts(); }

        // Events
        document.getElementById('timeSelect').addEventListener('change', (e) => {
            if(e.target.value) { const [y,m] = e.target.value.split('-'); loadMapData(y, m); }
        });
        document.getElementById('paramSelect').addEventListener('change', () => {
            if(document.getElementById('map-view').classList.contains('active')) {
                renderMapByDepth();
                if(document.getElementById('station-panel').style.display === 'block') renderOverviewCharts();
                else renderOverviewCharts();
            } else {
                loadSummaryData();
            }
        });
        document.getElementById('cruiseSelect').addEventListener('change', () => {
            loadSummaryData();
        });

        initApp();
    </script>
</body>
</html>