<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DMCR Analytics</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            --bg-canvas: #f6f8fa;
            --bg-surface: #ffffff;
            --border-default: #d0d7de;
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --accent-fg: #0969da;
            --success-fg: #1a7f37;
            --radius: 6px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }

        body { 
            margin: 0; padding: 0; 
            font-family: var(--font-stack);
            background-color: var(--bg-canvas);
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            /* Mobile Optimization: Prevent bounce scroll on main body */
            overscroll-behavior: none; 
        }
        
        h3 { font-size: 16px; font-weight: 600; margin: 0; }
        
        /* --- HEADER --- */
        #header {
            min-height: 60px;
            background-color: #24292f;
            color: white;
            display: flex; align-items: center; 
            padding: 0 20px; gap: 15px;
            z-index: 1000; position: relative;
            flex-wrap: wrap; /* Allow wrapping on mobile */
        }

        .brand-group { 
            display: flex; align-items: baseline; gap: 10px; margin-right: auto; 
            white-space: nowrap;
        }
        .brand-group h3 { color: white; font-size: 18px; font-weight: 600; }
        .brand-group span { color: #8b949e; font-size: 12px; }

        .nav-tabs { display: flex; gap: 5px; height: 100%; align-items: flex-end; }
        .nav-tab {
            padding: 12px 12px;
            color: #d0d7de; cursor: pointer; font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s; white-space: nowrap;
        }
        .nav-tab:hover { color: white; }
        .nav-tab.active { color: white; border-bottom: 3px solid #fd8c73; }

        /* --- CONTROLS --- */
        .controls-wrapper {
            display: flex; gap: 10px; align-items: center; margin-left: auto;
        }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 10px; color: #8b949e; font-weight: 600; margin-bottom: 2px; }
        select { 
            padding: 4px 8px; border: 1px solid #57606a; 
            background-color: #24292f; color: white;
            border-radius: var(--radius); font-size: 13px;
            max-width: 100%;
        }

        /* --- LAYOUT --- */
        .view-container { 
            display: none; 
            height: calc(100vh - 60px); 
            width: 100%; 
            /* Default Desktop Layout */
            flex-direction: row; 
        }
        .view-container.active { display: flex; }

        #map-container { 
            flex: 7; height: 100%; position: relative; 
            border-right: 1px solid var(--border-default); 
        }
        #map { height: 100%; width: 100%; z-index: 1; background: #eef1f5; }
        
        #sidebar { 
            flex: 3; height: 100%; background: var(--bg-canvas);
            overflow-y: auto; padding: 20px; box-sizing: border-box; 
            display: flex; flex-direction: column; gap: 16px;
        }

        /* --- CARDS --- */
        .card, .summary-col { 
            background: var(--bg-surface); 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius);
            padding: 16px; margin-bottom: 16px;
            box-shadow: 0 1px 0 rgba(27,31,36,0.04);
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-default);
            padding-bottom: 12px; margin-bottom: 12px;
        }
        .chart-wrapper { position: relative; width: 100%; min-height: 200px; }

        /* --- SUMMARY LAYOUT --- */
        #summary-view { flex-direction: column; padding: 24px; overflow-y: auto; gap: 20px; }
        .summary-row { display: flex; gap: 24px; min-height: 350px; }
        .summary-col { flex: 1; display: flex; flex-direction: column; margin-bottom: 0; }

        /* --- MAP CONTROLS --- */
        #depth-controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background-color: var(--bg-surface);
            padding: 8px 20px; border: 1px solid var(--border-default);
            border-radius: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 15px;
        }
        .nav-btn { cursor: pointer; font-size: 18px; color: var(--text-secondary); width: 30px; text-align: center; }
        .depth-info { text-align: center; white-space: nowrap; }
        .depth-title { font-size: 13px; font-weight: 600; display: block; }
        .depth-subtitle { font-size: 11px; color: var(--text-secondary); }

        .legend { 
            background: rgba(255,255,255,0.9); padding: 10px; 
            border: 1px solid var(--border-default); border-radius: var(--radius);
            font-size: 11px; width: 140px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .legend-gradient-bar { height: 6px; width: 100%; background: linear-gradient(to right, #ddf4ff, #0969da); margin-bottom: 6px; }
        .legend-labels { display: flex; justify-content: space-between; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: var(--border-default); border: 1px solid var(--border-default); border-radius: var(--radius); overflow: hidden; }
        .stat-box { background: var(--bg-surface); padding: 10px; text-align: center; }
        .stat-val { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .stat-label { font-size: 10px; color: var(--text-secondary); }

        /* =========================================
           ðŸ“± MOBILE RESPONSIVE MEDIA QUERIES 
           ========================================= */
        @media (max-width: 768px) {
            /* 1. Header Adjustment */
            #header {
                padding: 10px 16px;
                height: auto;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .brand-group { width: 100%; justify-content: space-between; margin: 0;}
            .nav-tabs { width: 100%; border-bottom: 1px solid #484f58; }
            .nav-tab { flex: 1; text-align: center; padding: 10px 0; }
            
            .controls-wrapper {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr; /* 2 Columns for inputs */
                gap: 10px;
                margin: 0;
            }
            .control-group { width: 100%; margin: 0 !important; }
            select { width: 100%; padding: 8px; font-size: 14px; /* Big touch target */ }

            /* 2. Map Layout Stack (Vertical) */
            .view-container {
                flex-direction: column;
                height: auto; /* Allow full page scroll */
                overflow-y: visible;
            }

            #map-container {
                flex: none;
                height: 50vh; /* Map takes half screen */
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-default);
            }

            #sidebar {
                flex: none;
                width: 100%;
                height: auto; /* Expand based on content */
                overflow-y: visible;
                padding: 16px;
            }

            /* 3. Summary View Adjustments */
            #summary-view { padding: 16px; gap: 16px; }
            .summary-row { flex-direction: column; height: auto; min-height: auto; gap: 16px; }
            .summary-col { width: 100%; }
            .chart-wrapper { min-height: 250px; }

            /* 4. Controls & Legend */
            #depth-controls {
                bottom: 20px;
                padding: 6px 16px;
                width: 80%; /* Wider touch area */
                justify-content: space-between;
            }
            .legend { bottom: 80px !important; right: 10px !important; } /* Move legend up */
        }
    </style>
</head>
<body>

    <div id="header">
        <div class="brand-group">
            <div style="display:flex; align-items:center; gap:8px;">
                <h3>DMCR Analytics</h3>
                <span>by nptppnm</span>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchView('map')">Map</div>
            <div class="nav-tab" onclick="switchView('summary')">Summary</div>
        </div>

        <div class="controls-wrapper">
            <div class="control-group" id="cruise-control-group" style="display:none;">
                <label>Cruise</label>
                <select id="cruiseSelect">
                    <option value="all">All</option>
                    <option value="GoT">GoT</option>
                    <option value="River">River</option>
                </select>
            </div>

            <div class="control-group" id="time-control-group">
                <label>Period</label>
                <select id="timeSelect"><option value="">Loading...</option></select>
            </div>

            <div class="control-group">
                <label>Parameter</label>
                <select id="paramSelect">
                    <option value="do_ctd_mg_l">DO (mg/L)</option>
                    <option value="salinity_ctd_psu">Salinity</option>
                    <option value="water_temperature_ctd_c">Temp (Â°C)</option>
                    <option value="chl_a_ctd_ug_l">Chl-a</option>
                    <option value="nitrate_um">Nitrate</option>
                    <option value="phosphate_um">Phosphate</option>
                    <option value="tss_mg_l">TSS</option>
                </select>
            </div>
        </div>
    </div>

    <div id="map-view" class="view-container active">
        <div id="map-container">
            <div id="map"></div>
            <div id="depth-controls">
                <div class="nav-btn" onclick="changeDepth(-1)">â—€</div>
                <div class="depth-info">
                    <span class="depth-title" id="depth-title">All Depths</span>
                    <span class="depth-subtitle" id="depth-subtitle">Average</span>
                </div>
                <div class="nav-btn" onclick="changeDepth(1)">â–¶</div>
            </div>
        </div>
        
        <div id="sidebar">
            <div class="card">
                <div class="card-header">
                    <h3>Statistics</h3>
                    <span style="font-size:11px; color:#57606a;" id="stats-subtitle"></span>
                </div>
                <div id="stats-content"><p style="text-align:center; color:#57606a; font-size:12px;">No Data</p></div>
            </div>
            
            <div id="overview-panel">
                <div class="card">
                    <div class="card-header"><h3>Average Profile</h3></div>
                    <div class="chart-wrapper"><canvas id="avgProfileChart"></canvas></div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Distribution</h3></div>
                    <div class="chart-wrapper"><canvas id="scatterChart"></canvas></div>
                </div>
            </div>
            
            <div class="card" id="station-panel" style="display:none;">
                <div class="card-header">
                    <h3>Station Profile</h3>
                    <span class="close-btn" onclick="closeStationView()">Ã—</span>
                </div>
                <p id="station-info" style="font-size:12px; color:#57606a; margin-bottom:12px;"></p>
                <div class="chart-wrapper" style="height:200px;"><canvas id="stationChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="summary-view" class="view-container">
        <div class="summary-row">
            <div class="summary-col">
                <div class="card-header"><h3>Station Rankings</h3></div>
                <div class="chart-wrapper"><canvas id="rankStationChart"></canvas></div>
            </div>
            <div class="summary-col">
                <div class="card-header"><h3>Yearly Trends</h3></div>
                <div class="chart-wrapper"><canvas id="rankYearChart"></canvas></div>
            </div>
        </div>
        
        <div class="summary-row" style="flex:1;">
            <div class="summary-col" style="flex:1; overflow:hidden;">
                <div class="card-header"><h3>Correlation Matrix</h3></div>
                <div style="overflow:auto; height:100%;" id="correlation-container"><p style="text-align:center; font-size:12px; color:#57606a; margin-top:20px;">Loading...</p></div>
            </div>
            <div class="summary-col" style="flex:1;">
                <div class="card-header">
                    <h3 id="corr-chart-title">Analysis</h3>
                </div>
                <div class="chart-wrapper"><canvas id="corrScatterChart"></canvas></div>
                <p style="font-size:11px; text-align:center; color:#57606a; margin-top:8px;">Select a cell to view correlation.</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif';
        Chart.defaults.font.size = 11; /* Smaller font for mobile readability */
        Chart.defaults.color = '#57606a'; 
        Chart.defaults.maintainAspectRatio = false; /* Crucial for responsive charts */
        
        const ghColors = {
            blue: '#0969da',
            green: '#2da44e',
            bgGreen: 'rgba(45, 164, 78, 0.1)'
        };

        const map = L.map('map', { zoomControl: false }).setView([13.0, 100.5], 6);
        // Move zoom control to top-right for better mobile UX
        L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { 
            attribution: '&copy; CARTO' 
        }).addTo(map);
        
        const markersLayer = L.featureGroup().addTo(map);
        let legendControl = L.control({position: 'bottomright'});
        
        let allData = [];
        let globalParamLimits = null;
        let correlationData = null;
        
        let stationChart=null, avgProfileChart=null, scatterChart=null;
        let rankStationChart=null, rankYearChart=null, corrScatterChart=null;

        let currentDepthIndex = 0;
        const depthLevels = [
            { id: 'all', dbValue: null, title: 'All Depths', subtitle: 'Average' },
            { id: 'surface', dbValue: 'S', title: 'Surface', subtitle: '0-1m' },
            { id: 'mid', dbValue: 'M', title: 'Mid-Water', subtitle: 'Mid' },
            { id: 'bottom', dbValue: 'B', title: 'Bottom', subtitle: 'Seabed' }
        ];
        const levelMap = { 'S': 'Surface', 'M': 'Mid-Water', 'B': 'Bottom' };
        const yLabelsOrder = ['Surface', 'Mid-Water', 'Bottom'];
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        const paramNames = {
            'do_ctd_mg_l': 'DO', 'salinity_ctd_psu': 'Salinity',
            'water_temperature_ctd_c': 'Temp', 'chl_a_ctd_ug_l': 'Chl-a',
            'nitrate_um': 'NO3', 'phosphate_um': 'PO4', 'tss_mg_l': 'TSS'
        };
        const paramsList = Object.keys(paramNames);

        async function initApp() {
            await Promise.all([initDropdown(), fetchGlobalStats()]);
            const initialTime = document.getElementById('timeSelect').value;
            if(initialTime) { const [y, m] = initialTime.split('-'); loadMapData(y, m); }
        }

        async function initDropdown() {
            try {
                const res = await fetch('/api/available-months');
                const data = await res.json();
                const select = document.getElementById('timeSelect');
                select.innerHTML = '';
                data.forEach(item => {
                    const value = `${item.year}-${item.month}`;
                    const text = `${item.year} - ${monthNames[item.month - 1]}`;
                    select.innerHTML += `<option value="${value}">${text}</option>`;
                });
            } catch (e) { console.error(e); }
        }

        async function fetchGlobalStats() {
            try {
                const res = await fetch('/api/global-stats');
                globalParamLimits = await res.json();
            } catch (e) { console.error(e); }
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            
            const timeCtrl = document.getElementById('time-control-group');
            const cruiseCtrl = document.getElementById('cruise-control-group');

            if (viewName === 'map') {
                document.getElementById('map-view').classList.add('active');
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
                timeCtrl.style.display = 'flex';
                cruiseCtrl.style.display = 'none';
                setTimeout(() => map.invalidateSize(), 100);
            } else {
                document.getElementById('summary-view').classList.add('active');
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
                timeCtrl.style.display = 'none';
                cruiseCtrl.style.display = 'flex'; // Changed to flex for mobile layout
                loadSummaryData();
            }
        }

        function loadMapData(year, month) {
            let url = `/api/stations?year=${year}&month=${month}`;
            fetch(url).then(res => res.json()).then(data => {
                allData = data;
                renderMapByDepth();
                renderOverviewCharts();
            });
        }

        function changeDepth(dir) {
            currentDepthIndex += dir;
            if (currentDepthIndex >= depthLevels.length) currentDepthIndex = 0;
            if (currentDepthIndex < 0) currentDepthIndex = depthLevels.length - 1;
            const current = depthLevels[currentDepthIndex];
            document.getElementById('depth-title').innerText = current.title;
            document.getElementById('depth-subtitle').innerText = current.subtitle;
            renderMapByDepth();
        }

        function getColor(value, min, max) {
            if (value === null || value === undefined) return '#d0d7de';
            if (max === min) return '#57606a';
            const ratio = (value - min) / (max - min);
            if (ratio > 0.8) return '#0550ae'; 
            if (ratio > 0.6) return '#0969da'; 
            if (ratio > 0.4) return '#218bff'; 
            if (ratio > 0.2) return '#54aeff'; 
            return '#ddf4ff'; 
        }

        function renderMapByDepth() {
            markersLayer.clearLayers();
            const currentLevel = depthLevels[currentDepthIndex];
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;

            let displayData = [];
            if (currentLevel.dbValue === null) {
                const stations = {};
                allData.forEach(d => {
                    if (!stations[d.station]) stations[d.station] = { lat: d.lat, lon: d.lon, station: d.station, sampling_level: 'Average', values: [] };
                    if (d[param] !== null) stations[d.station].values.push(d[param]);
                });
                displayData = Object.values(stations).map(s => {
                    const avg = s.values.length > 0 ? s.values.reduce((a,b)=>a+b,0)/s.values.length : null;
                    return { ...s, [param]: avg };
                });
            } else {
                displayData = allData.filter(d => d.sampling_level && d.sampling_level.trim() === currentLevel.dbValue);
            }

            let minVal = 0, maxVal = 0;
            if (globalParamLimits) {
                minVal = globalParamLimits[`min_${param}`];
                maxVal = globalParamLimits[`max_${param}`];
            } else {
                const vals = displayData.map(d => d[param]).filter(v => v !== null);
                minVal = Math.min(...vals); maxVal = Math.max(...vals);
            }

            updateStats(displayData, param, currentLevel.title, minVal, maxVal);
            updateLegend(minVal, maxVal, paramName);

            const drawn = new Set();
            displayData.forEach(point => {
                const val = point[param];
                if (val !== null && val !== undefined) {
                    if (currentLevel.dbValue !== null) {
                        if (drawn.has(point.station)) return;
                        drawn.add(point.station);
                    }
                    const color = getColor(val, minVal, maxVal);
                    const marker = L.circleMarker([point.lat, point.lon], { 
                        radius: 7, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.9
                    });
                    marker.bindPopup(`<div style="text-align:center; font-family:-apple-system;"><b>${point.station}</b><br><span style="font-size:11px; color:#57606a;">${point.sampling_level}</span><br>${paramName}: <b style="color:${color}">${val.toFixed(2)}</b></div>`);
                    marker.on('click', () => renderStationProfile(point.station));
                    markersLayer.addLayer(marker);
                }
            });
            if (markersLayer.getLayers().length > 0) map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
        }

        function updateStats(data, param, levelTitle, minV, maxV) {
            const vals = data.map(d => d[param]).filter(v => v !== null);
            document.getElementById('stats-subtitle').innerText = `(${levelTitle})`;
            if (vals.length === 0) { document.getElementById('stats-content').innerHTML = "No Data"; return; }
            const min = Math.min(...vals).toFixed(2);
            const max = Math.max(...vals).toFixed(2);
            const avg = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
            document.getElementById('stats-content').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-val">${min}</div><div class="stat-label">Min</div></div>
                    <div class="stat-box"><div class="stat-val">${avg}</div><div class="stat-label">Avg</div></div>
                    <div class="stat-box"><div class="stat-val">${max}</div><div class="stat-label">Max</div></div>
                </div>`;
        }

        function updateLegend(min, max, name) {
            if (legendControl) map.removeControl(legendControl);
            legendControl = L.control({position: 'bottomright'});
            legendControl.onAdd = function () {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `<h4 style="margin:0 0 8px; font-weight:600;">${name}</h4><div class="legend-gradient-bar"></div>
                <div class="legend-labels"><span>${min.toFixed(2)}</span><span>${max.toFixed(2)}</span></div>`;
                return div;
            };
            legendControl.addTo(map);
        }

        function loadSummaryData() {
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;
            const cruise = document.getElementById('cruiseSelect').value;

            fetch(`/api/summary/rankings?param=${param}&cruise=${cruise}`)
                .then(res => res.json())
                .then(data => { renderRankingCharts(data.stations, data.years, paramName); });

            fetch(`/api/summary/correlation-data?cruise=${cruise}`)
                .then(res => res.json())
                .then(data => {
                    correlationData = data;
                    renderCorrelationMatrix(data);
                    updateCorrScatterChart(paramsList[0], paramsList[1]);
                });
        }

        function renderRankingCharts(stations, years, paramName) {
            const sortedStations = stations.sort((a,b) => b.avg_val - a.avg_val);
            const displaySt = sortedStations.slice(0, 10);
            
            const ctxSt = document.getElementById('rankStationChart').getContext('2d');
            if (rankStationChart) rankStationChart.destroy();
            rankStationChart = new Chart(ctxSt, {
                type: 'bar',
                data: {
                    labels: displaySt.map(d => d.station),
                    datasets: [{
                        label: `Avg ${paramName}`,
                        data: displaySt.map(d => d.avg_val),
                        backgroundColor: ghColors.blue,
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });

            const sortedYears = years.sort((a,b) => a.year - b.year);
            const ctxYr = document.getElementById('rankYearChart').getContext('2d');
            if (rankYearChart) rankYearChart.destroy();
            rankYearChart = new Chart(ctxYr, {
                type: 'bar',
                data: {
                    labels: sortedYears.map(d => d.year),
                    datasets: [{
                        label: `Avg ${paramName}`,
                        data: sortedYears.map(d => d.avg_val),
                        backgroundColor: ghColors.green,
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderCorrelationMatrix(data) {
            if (!data || data.length === 0) { document.getElementById('correlation-container').innerHTML = "<p>No Data</p>"; return; }
            const shortNames = paramsList.map(k => paramNames[k]);
            const calcCorr = (keyX, keyY) => {
                const n = data.length;
                let sumX=0, sumY=0, sumXY=0, sumX2=0, sumY2=0, count=0;
                for(let i=0; i<n; i++) {
                    const x = data[i][keyX], y = data[i][keyY];
                    if(x!==null && y!==null) { sumX+=x; sumY+=y; sumXY+=x*y; sumX2+=x*x; sumY2+=y*y; count++; }
                }
                if (count === 0) return 0;
                const num = (count * sumXY) - (sumX * sumY);
                const den = Math.sqrt((count * sumX2 - sumX*sumX) * (count * sumY2 - sumY*sumY));
                return den === 0 ? 0 : num / den;
            };

            let html = '<table class="corr-table"><thead><tr><th></th>';
            shortNames.forEach(n => html += `<th>${n}</th>`);
            html += '</tr></thead><tbody>';

            paramsList.forEach((p1, i) => {
                html += `<tr><th>${shortNames[i]}</th>`;
                paramsList.forEach((p2, j) => {
                    if (i === j) html += '<td style="background:#f6f8fa; color:#d0d7de;">1.00</td>';
                    else {
                        const r = calcCorr(p1, p2);
                        let bg = 'transparent';
                        if(r > 0) bg = `rgba(9, 105, 218, ${Math.abs(r)})`; 
                        else bg = `rgba(207, 34, 46, ${Math.abs(r)})`; 
                        
                        let textColor = Math.abs(r) > 0.5 ? 'white' : 'inherit';
                        html += `<td class="corr-cell" onclick="updateCorrScatterChart('${p1}', '${p2}', this)" style="background:${bg}; color:${textColor}">${r.toFixed(2)}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('correlation-container').innerHTML = html;
        }

        function calculateLinearRegression(data) {
            const n = data.length;
            if (n === 0) return { m: 0, b: 0, r2: 0 };
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, sumYY = 0;
            data.forEach(p => { sumX += p.x; sumY += p.y; sumXY += p.x * p.y; sumXX += p.x * p.x; sumYY += p.y * p.y; });
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const num = (n * sumXY - sumX * sumY);
            const den = Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
            const r = den === 0 ? 0 : num / den;
            return { m: slope, b: intercept, r2: r * r };
        }

        function updateCorrScatterChart(xKey, yKey, cellElement) {
            document.querySelectorAll('.corr-cell').forEach(el => el.classList.remove('active'));
            if(cellElement) cellElement.classList.add('active');
            const xName = paramNames[xKey], yName = paramNames[yKey];
            const dataPoints = correlationData.filter(d => d[xKey]!==null && d[yKey]!==null).map(d => ({ x: d[xKey], y: d[yKey] }));
            const reg = calculateLinearRegression(dataPoints);
            const minX = Math.min(...dataPoints.map(d => d.x)), maxX = Math.max(...dataPoints.map(d => d.x));
            const trendData = [{ x: minX, y: reg.m * minX + reg.b }, { x: maxX, y: reg.m * maxX + reg.b }];

            document.getElementById('corr-chart-title').innerHTML = `${xName} vs ${yName} <span style="font-weight:400; color:#57606a;">(RÂ²=${reg.r2.toFixed(3)})</span>`;
            const ctx = document.getElementById('corrScatterChart').getContext('2d');
            if (corrScatterChart) corrScatterChart.destroy();
            corrScatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Data', data: dataPoints, backgroundColor: ghColors.blue, pointRadius: 2 },
                        { label: 'Trend', data: trendData, type: 'line', borderColor: '#cf222e', borderWidth: 2, pointRadius: 0, fill: false, tension:0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: xName } }, y: { title: { display: true, text: yName } } } }
            });
        }

        function renderOverviewCharts() {
            document.getElementById('overview-panel').style.display = 'block';
            document.getElementById('station-panel').style.display = 'none';
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;

            const calcAvg = (lvl) => {
                const grp = allData.filter(d => d.sampling_level === lvl && d[param] !== null);
                if(grp.length === 0) return null;
                return grp.reduce((a,b)=>a+b[param],0)/grp.length;
            };
            const lineData = [];
            ['S','M','B'].forEach((l, i) => {
                const val = calcAvg(l);
                if(val!==null) lineData.push({x: val, y: yLabelsOrder[i]});
            });

            const ctxAvg = document.getElementById('avgProfileChart').getContext('2d');
            if (avgProfileChart) avgProfileChart.destroy();
            avgProfileChart = new Chart(ctxAvg, {
                type: 'line',
                data: { labels: yLabelsOrder, datasets: [{ label: 'Average Profile', data: lineData, borderColor: ghColors.green, backgroundColor: ghColors.bgGreen, tension: 0.3, pointRadius:4, fill:true }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { reverse: true, type:'category' }, x:{title:{display:true,text:paramName}} } }
            });

            const scatterData = allData.filter(d => d[param]!==null && d.sampling_depth_m!==null).map(d => ({x:d[param], y:d.sampling_depth_m}));
            const ctxScat = document.getElementById('scatterChart').getContext('2d');
            if (scatterChart) scatterChart.destroy();
            scatterChart = new Chart(ctxScat, {
                type: 'scatter',
                data: { datasets: [{ label: 'All Data', data: scatterData, backgroundColor: 'rgba(9, 105, 218, 0.5)', pointRadius:2.5 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { reverse: true, title:{display:true, text:'Depth (m)'} }, x:{title:{display:true,text:paramName}} } }
            });
        }

        function renderStationProfile(stationName) {
            document.getElementById('overview-panel').style.display = 'none';
            document.getElementById('station-panel').style.display = 'block';
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;
            const sData = allData.filter(d => d.station===stationName && d[param]!==null);
            
            const ctx = document.getElementById('stationChart').getContext('2d');
            if(stationChart) stationChart.destroy();
            stationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yLabelsOrder,
                    datasets: [{ label: stationName, data: sData.map(d=>({x:d[param], y:levelMap[d.sampling_level]||d.sampling_level})), borderColor: ghColors.blue, tension:0, fill:false, pointBackgroundColor: ghColors.blue }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { type: 'category', reverse: true, title: { display: true, text: 'Level' } }, x:{title:{display:true,text:paramName}} } }
            });
            document.getElementById('station-info').innerHTML = `Station: <b>${stationName}</b> &middot; Parameter: ${paramName}`;
        }

        function closeStationView() { renderOverviewCharts(); }

        // Events
        document.getElementById('timeSelect').addEventListener('change', (e) => {
            if(e.target.value) { const [y,m] = e.target.value.split('-'); loadMapData(y, m); }
        });
        document.getElementById('paramSelect').addEventListener('change', () => {
            if(document.getElementById('map-view').classList.contains('active')) {
                renderMapByDepth();
                if(document.getElementById('station-panel').style.display === 'block') renderOverviewCharts();
                else renderOverviewCharts();
            } else {
                loadSummaryData();
            }
        });
        document.getElementById('cruiseSelect').addEventListener('change', () => {
            loadSummaryData();
        });

        initApp();
    </script>
</body>
</html>