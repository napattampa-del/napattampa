<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMCR Analytics Platform</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Sarabun', sans-serif; overflow: hidden; background-color: #f4f6f9;}
        
        /* Header */
        #header {
            height: 60px;
            background-color: #ffffff;
            border-bottom: 1px solid #ddd;
            display: flex; align-items: center; padding: 0 20px; gap: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 1000;
        }
        
        .nav-tabs { display: flex; gap: 10px; margin-right: auto; }
        .nav-tab {
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold; color: #555;
            transition: 0.2s; border: 1px solid transparent;
        }
        .nav-tab:hover { background: #f0f0f0; }
        .nav-tab.active { background: #0078A8; color: white; }

        .control-group { display: flex; flex-direction: column; }
        .control-group label { font-size: 11px; color: #666; margin-bottom: 2px; text-transform: uppercase; font-weight: bold;}
        select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; min-width: 160px; background: #f9f9f9; cursor: pointer; }

        /* Views */
        .view-container { display: none; height: calc(100vh - 60px); width: 100%; }
        .view-container.active { display: flex; }

        /* Map View */
        #map-container { flex: 7; height: 100%; position: relative; }
        #map { height: 100%; width: 100%; z-index: 1; }
        #sidebar { flex: 3; height: 100%; background: #fff; border-left: 1px solid #ddd; overflow-y: auto; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; gap: 15px; }

        /* Summary View */
        #summary-view { flex-direction: column; padding: 20px; overflow-y: auto; box-sizing: border-box; gap: 20px; }
        .summary-row { display: flex; gap: 20px; height: 45%; min-height: 350px; }
        .summary-col { flex: 1; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        .card { background: #fff; border: 1px solid #e1e4e8; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; }
        .card h3, .summary-col h3 { margin: 0 0 10px 0; font-size: 16px; color: #0078A8; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }
        
        .chart-wrapper { flex: 1; position: relative; width: 100%; }
        
        #depth-controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background-color: rgba(255, 255, 255, 0.95);
            padding: 8px 25px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 20px;
            border: 1px solid #e1e4e8; transition: all 0.3s ease;
        }
        .nav-btn { cursor: pointer; font-size: 24px; color: #0078A8; width: 30px; text-align: center; }
        .depth-title { font-size: 15px; font-weight: bold; display: block; text-align: center; }
        .depth-subtitle { font-size: 11px; color: #888; display: block; text-align: center; }

        .corr-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        .corr-table th, .corr-table td { padding: 6px; border: 1px solid #eee; }
        .corr-table th { background: #f8f9fa; font-weight: bold; color: #333; }
        .corr-cell { cursor: pointer; transition: 0.1s; }
        .corr-cell:hover { border: 2px solid #333; transform: scale(1.05); z-index: 1; }
        .corr-cell.active { border: 3px solid #000; }

        .legend { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 11px; width: 180px; }
        .legend-gradient-bar { height: 15px; width: 100%; background: linear-gradient(to right, #c6dbef, #08519c); margin-bottom: 5px; border: 1px solid #ccc; }
        .legend-labels { display: flex; justify-content: space-between; color: #666; }
        
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .stat-box { background: #f8f9fa; padding: 8px; border-radius: 6px; }
        .stat-val { font-size: 18px; font-weight: bold; color: #0078A8; }
        .stat-label { font-size: 11px; color: #666; }
    </style>
</head>
<body>

    <div id="header">
        <h3 style="margin:0; color:#0078A8; white-space:nowrap;">DMCR Analytics</h3>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchView('map')">üó∫Ô∏è Map Analysis</div>
            <div class="nav-tab" onclick="switchView('summary')">üìä Summary Report</div>
        </div>

        <div class="control-group" id="cruise-control-group" style="display:none;">
            <label>üö¢ Cruise</label>
            <select id="cruiseSelect">
                <option value="all">All Cruises</option>
                <option value="GoT">Gulf of Thailand (GoT)</option>
                <option value="River">River</option>
            </select>
        </div>

        <div class="control-group" id="time-control-group">
            <label>üìÖ Time Period</label>
            <select id="timeSelect"><option value="">Loading...</option></select>
        </div>

        <div class="control-group">
            <label>üß™ Parameter</label>
            <select id="paramSelect">
                <option value="do_ctd_mg_l">Dissolved Oxygen (DO)</option>
                <option value="salinity_ctd_psu">Salinity</option>
                <option value="water_temperature_ctd_c">Temperature</option>
                <option value="chl_a_ctd_ug_l">Chlorophyll-a</option>
                <option value="nitrate_um">Nitrate (NO3)</option>
                <option value="phosphate_um">Phosphate (PO4)</option>
                <option value="tss_mg_l">TSS</option>
            </select>
        </div>
    </div>

    <div id="map-view" class="view-container active">
        <div id="map-container">
            <div id="map"></div>
            <div id="depth-controls">
                <div class="nav-btn" onclick="changeDepth(-1)">&#10094;</div>
                <div class="depth-label-container">
                    <span class="depth-title" id="depth-title">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</span>
                    <span class="depth-subtitle" id="depth-subtitle">Average (All Depths)</span>
                </div>
                <div class="nav-btn" onclick="changeDepth(1)">&#10095;</div>
            </div>
        </div>
        
        <div id="sidebar">
            <div class="card">
                <h3>üìä Current Stats <span style="font-size:12px; color:#666; font-weight:normal;" id="stats-subtitle"></span></h3>
                <div id="stats-content"><p style="text-align:center; color:#888;">Loading...</p></div>
            </div>
            <div id="overview-panel">
                <div class="card">
                    <h3>üåä Average Profile</h3>
                    <div class="chart-wrapper"><canvas id="avgProfileChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>‚ú® Scatter Plot</h3>
                    <div class="chart-wrapper"><canvas id="scatterChart"></canvas></div>
                </div>
            </div>
            <div class="card" id="station-panel" style="display:none;">
                <span class="close-btn" onclick="closeStationView()">√ó</span>
                <h3>üìç Station Profile</h3>
                <p id="station-info" style="font-size:13px; color:#555; margin-bottom:10px;"></p>
                <div class="chart-wrapper" style="height:250px;"><canvas id="stationChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="summary-view" class="view-container">
        <div class="summary-row">
            <div class="summary-col">
                <h3>üèÜ Station Rankings (Top/Bottom)</h3>
                <div class="chart-wrapper"><canvas id="rankStationChart"></canvas></div>
            </div>
            <div class="summary-col">
                <h3>üìÖ Yearly Trends</h3>
                <div class="chart-wrapper"><canvas id="rankYearChart"></canvas></div>
            </div>
        </div>
        
        <div class="summary-row" style="flex:1;">
            <div class="summary-col" style="flex:1; overflow:hidden;">
                <h3>üîó Correlation Matrix</h3>
                <div style="overflow:auto; height:100%;" id="correlation-container"><p>Loading...</p></div>
            </div>
            <div class="summary-col" style="flex:1;">
                <h3 id="corr-chart-title">üìà Relationship & Trendline</h3>
                <div class="chart-wrapper"><canvas id="corrScatterChart"></canvas></div>
                <p style="font-size:11px; text-align:center; color:#888;">Select a cell in the matrix to view detailed scatter plot with trendline.</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const map = L.map('map').setView([13.0, 100.5], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
        const markersLayer = L.featureGroup().addTo(map);
        let legendControl = L.control({position: 'bottomright'});
        
        let allData = [];
        let globalParamLimits = null;
        let correlationData = null;
        
        let stationChart=null, avgProfileChart=null, scatterChart=null;
        let rankStationChart=null, rankYearChart=null, corrScatterChart=null;

        let currentDepthIndex = 0;
        const depthLevels = [
            { id: 'all', dbValue: null, title: '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö', subtitle: 'Average (All Depths)' },
            { id: 'surface', dbValue: 'S', title: '‡∏ú‡∏¥‡∏ß‡∏ô‡πâ‡∏≥ (Surface)', subtitle: 'Depth ~ 0-1m' },
            { id: 'mid', dbValue: 'M', title: '‡∏Å‡∏•‡∏≤‡∏á‡∏ô‡πâ‡∏≥ (Mid-Water)', subtitle: 'Mid Depth' },
            { id: 'bottom', dbValue: 'B', title: '‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏¥‡∏ô (Bottom)', subtitle: 'Seabed' }
        ];
        const levelMap = { 'S': 'Surface', 'M': 'Mid-Water', 'B': 'Bottom' };
        const yLabelsOrder = ['Surface', 'Mid-Water', 'Bottom'];
        const monthNames = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

        const paramNames = {
            'do_ctd_mg_l': 'DO',
            'salinity_ctd_psu': 'Sal',
            'water_temperature_ctd_c': 'Temp',
            'chl_a_ctd_ug_l': 'Chl-a',
            'nitrate_um': 'NO3',
            'phosphate_um': 'PO4',
            'tss_mg_l': 'TSS'
        };
        const paramsList = Object.keys(paramNames);

        async function initApp() {
            await Promise.all([initDropdown(), fetchGlobalStats()]);
            const initialTime = document.getElementById('timeSelect').value;
            if(initialTime) { const [y, m] = initialTime.split('-'); loadMapData(y, m); }
        }

        async function initDropdown() {
            try {
                const res = await fetch('/api/available-months');
                const data = await res.json();
                const select = document.getElementById('timeSelect');
                select.innerHTML = '';
                data.forEach(item => {
                    const value = `${item.year}-${item.month}`;
                    const text = `${item.year} - ${monthNames[item.month - 1]}`;
                    select.innerHTML += `<option value="${value}">${text}</option>`;
                });
            } catch (e) { console.error(e); }
        }

        async function fetchGlobalStats() {
            try {
                const res = await fetch('/api/global-stats');
                globalParamLimits = await res.json();
            } catch (e) { console.error(e); }
        }

        function switchView(viewName) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            
            const timeCtrl = document.getElementById('time-control-group');
            const cruiseCtrl = document.getElementById('cruise-control-group');

            if (viewName === 'map') {
                document.getElementById('map-view').classList.add('active');
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
                timeCtrl.style.display = 'flex';
                cruiseCtrl.style.display = 'none';
                setTimeout(() => map.invalidateSize(), 100);
            } else {
                document.getElementById('summary-view').classList.add('active');
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
                timeCtrl.style.display = 'none';
                cruiseCtrl.style.display = 'flex';
                loadSummaryData();
            }
        }

        // --- MAP FUNCTIONS ---
        function loadMapData(year, month) {
            let url = `/api/stations?year=${year}&month=${month}`;
            fetch(url).then(res => res.json()).then(data => {
                allData = data;
                renderMapByDepth();
                renderOverviewCharts();
            });
        }

        function changeDepth(dir) {
            currentDepthIndex += dir;
            if (currentDepthIndex >= depthLevels.length) currentDepthIndex = 0;
            if (currentDepthIndex < 0) currentDepthIndex = depthLevels.length - 1;
            const current = depthLevels[currentDepthIndex];
            document.getElementById('depth-title').innerText = current.title;
            document.getElementById('depth-subtitle').innerText = current.subtitle;
            renderMapByDepth();
        }

        function getColor(value, min, max) {
            if (value === null || value === undefined) return '#808080';
            if (max === min) return '#6baed6';
            const ratio = (value - min) / (max - min);
            if (ratio > 0.8) return '#08519c';
            if (ratio > 0.6) return '#3182bd';
            if (ratio > 0.4) return '#6baed6';
            if (ratio > 0.2) return '#9ecae1';
            return '#c6dbef';
        }

        function renderMapByDepth() {
            markersLayer.clearLayers();
            const currentLevel = depthLevels[currentDepthIndex];
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;

            let displayData = [];
            if (currentLevel.dbValue === null) {
                const stations = {};
                allData.forEach(d => {
                    if (!stations[d.station]) stations[d.station] = { lat: d.lat, lon: d.lon, station: d.station, sampling_level: 'Average', values: [] };
                    if (d[param] !== null) stations[d.station].values.push(d[param]);
                });
                displayData = Object.values(stations).map(s => {
                    const avg = s.values.length > 0 ? s.values.reduce((a,b)=>a+b,0)/s.values.length : null;
                    return { ...s, [param]: avg };
                });
            } else {
                displayData = allData.filter(d => d.sampling_level && d.sampling_level.trim() === currentLevel.dbValue);
            }

            let minVal = 0, maxVal = 0;
            if (globalParamLimits) {
                minVal = globalParamLimits[`min_${param}`];
                maxVal = globalParamLimits[`max_${param}`];
            } else {
                const vals = displayData.map(d => d[param]).filter(v => v !== null);
                minVal = Math.min(...vals); maxVal = Math.max(...vals);
            }

            updateStats(displayData, param, currentLevel.title, minVal, maxVal);
            updateLegend(minVal, maxVal, paramName);

            const drawn = new Set();
            displayData.forEach(point => {
                const val = point[param];
                if (val !== null && val !== undefined) {
                    if (currentLevel.dbValue !== null) {
                        if (drawn.has(point.station)) return;
                        drawn.add(point.station);
                    }
                    const color = getColor(val, minVal, maxVal);
                    const marker = L.circleMarker([point.lat, point.lon], { radius: 8, fillColor: color, color: "#333", weight: 1, opacity: 1, fillOpacity: 1 });
                    marker.bindPopup(`<div style="text-align:center"><b>${point.station}</b><br>(${point.sampling_level})<br>${paramName}: <b style="color:${color}">${val.toFixed(2)}</b></div>`);
                    marker.on('click', () => renderStationProfile(point.station));
                    markersLayer.addLayer(marker);
                }
            });
            if (markersLayer.getLayers().length > 0) map.fitBounds(markersLayer.getBounds(), { padding: [50, 50] });
        }

        function updateStats(data, param, levelTitle, minV, maxV) {
            const vals = data.map(d => d[param]).filter(v => v !== null);
            document.getElementById('stats-subtitle').innerText = `(${levelTitle})`;
            if (vals.length === 0) { document.getElementById('stats-content').innerHTML = "No Data"; return; }
            const min = Math.min(...vals).toFixed(2);
            const max = Math.max(...vals).toFixed(2);
            const avg = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
            document.getElementById('stats-content').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-val" style="color:#3182bd">${min}</div><div class="stat-label">Min (View)</div></div>
                    <div class="stat-box"><div class="stat-val" style="color:#333">${avg}</div><div class="stat-label">Avg (View)</div></div>
                    <div class="stat-box"><div class="stat-val" style="color:#08519c">${max}</div><div class="stat-label">Max (View)</div></div>
                </div>`;
        }

        function updateLegend(min, max, name) {
            if (legendControl) map.removeControl(legendControl);
            legendControl = L.control({position: 'bottomright'});
            legendControl.onAdd = function () {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `<h4>${name}</h4><div class="legend-gradient-bar"></div>
                <div class="legend-labels"><span>Low (${min.toFixed(2)})</span><span>High (${max.toFixed(2)})</span></div>
                <div style="font-size:10px;color:#999;text-align:center;margin-top:5px">Global Scale</div>`;
                return div;
            };
            legendControl.addTo(map);
        }

        // --- SUMMARY LOGIC ---
        function loadSummaryData() {
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;
            const cruise = document.getElementById('cruiseSelect').value;

            fetch(`/api/summary/rankings?param=${param}&cruise=${cruise}`)
                .then(res => res.json())
                .then(data => {
                    renderRankingCharts(data.stations, data.years, paramName);
                });

            fetch(`/api/summary/correlation-data?cruise=${cruise}`)
                .then(res => res.json())
                .then(data => {
                    correlationData = data;
                    renderCorrelationMatrix(data);
                    updateCorrScatterChart(paramsList[0], paramsList[1]);
                });
        }

        function renderRankingCharts(stations, years, paramName) {
            const sortedStations = stations.sort((a,b) => b.avg_val - a.avg_val);
            const displaySt = sortedStations.slice(0, 10);
            
            const ctxSt = document.getElementById('rankStationChart').getContext('2d');
            if (rankStationChart) rankStationChart.destroy();
            rankStationChart = new Chart(ctxSt, {
                type: 'bar',
                data: {
                    labels: displaySt.map(d => d.station),
                    datasets: [{
                        label: `Avg ${paramName}`,
                        data: displaySt.map(d => d.avg_val),
                        backgroundColor: '#0078A8'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });

            const sortedYears = years.sort((a,b) => a.year - b.year);
            const ctxYr = document.getElementById('rankYearChart').getContext('2d');
            if (rankYearChart) rankYearChart.destroy();
            rankYearChart = new Chart(ctxYr, {
                type: 'bar',
                data: {
                    labels: sortedYears.map(d => d.year),
                    datasets: [{
                        label: `Avg ${paramName}`,
                        data: sortedYears.map(d => d.avg_val),
                        backgroundColor: '#28a745'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderCorrelationMatrix(data) {
            if (!data || data.length === 0) { document.getElementById('correlation-container').innerHTML = "<p>No Data</p>"; return; }
            
            const shortNames = paramsList.map(k => paramNames[k]);

            const calcCorr = (keyX, keyY) => {
                const n = data.length;
                let sumX=0, sumY=0, sumXY=0, sumX2=0, sumY2=0, count=0;
                for(let i=0; i<n; i++) {
                    const x = data[i][keyX];
                    const y = data[i][keyY];
                    if(x!==null && y!==null) {
                        sumX+=x; sumY+=y; sumXY+=x*y; sumX2+=x*x; sumY2+=y*y; count++;
                    }
                }
                if (count === 0) return 0;
                const num = (count * sumXY) - (sumX * sumY);
                const den = Math.sqrt((count * sumX2 - sumX*sumX) * (count * sumY2 - sumY*sumY));
                return den === 0 ? 0 : num / den;
            };

            let html = '<table class="corr-table"><thead><tr><th></th>';
            shortNames.forEach(n => html += `<th>${n}</th>`);
            html += '</tr></thead><tbody>';

            paramsList.forEach((p1, i) => {
                html += `<tr><th>${shortNames[i]}</th>`;
                paramsList.forEach((p2, j) => {
                    if (i === j) {
                        html += '<td style="background:#eee;">1.00</td>';
                    } else {
                        const r = calcCorr(p1, p2);
                        let bg = '#fff';
                        if(r > 0) bg = `rgba(215, 25, 28, ${Math.abs(r)})`; 
                        else bg = `rgba(44, 123, 182, ${Math.abs(r)})`; 
                        
                        html += `<td class="corr-cell" onclick="updateCorrScatterChart('${p1}', '${p2}', this)" 
                                     style="background:${bg}; color:${Math.abs(r)>0.5?'white':'black'}">${r.toFixed(2)}</td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('correlation-container').innerHTML = html;
        }

        // --- MATH: Calculate Linear Regression ---
        function calculateLinearRegression(data) {
            const n = data.length;
            if (n === 0) return { m: 0, b: 0, r2: 0 };

            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, sumYY = 0;
            data.forEach(p => {
                sumX += p.x; sumY += p.y;
                sumXY += p.x * p.y;
                sumXX += p.x * p.x;
                sumYY += p.y * p.y;
            });

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // R-squared
            const num = (n * sumXY - sumX * sumY);
            const den = Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
            const r = den === 0 ? 0 : num / den;
            const r2 = r * r;

            return { m: slope, b: intercept, r2: r2 };
        }

        // --- UPDATE CORR SCATTER WITH TRENDLINE ---
        function updateCorrScatterChart(xKey, yKey, cellElement) {
            document.querySelectorAll('.corr-cell').forEach(el => el.classList.remove('active'));
            if(cellElement) cellElement.classList.add('active');

            const xName = paramNames[xKey];
            const yName = paramNames[yKey];
            
            const dataPoints = correlationData
                .filter(d => d[xKey]!==null && d[yKey]!==null)
                .map(d => ({ x: d[xKey], y: d[yKey] }));

            // Calculate Trendline
            const reg = calculateLinearRegression(dataPoints);
            const minX = Math.min(...dataPoints.map(d => d.x));
            const maxX = Math.max(...dataPoints.map(d => d.x));
            
            // Generate line points (2 points are enough for straight line)
            const trendData = [
                { x: minX, y: reg.m * minX + reg.b },
                { x: maxX, y: reg.m * maxX + reg.b }
            ];

            document.getElementById('corr-chart-title').innerHTML = 
                `üìà ${xName} vs ${yName} <span style="font-size:12px; font-weight:normal; color:#666; margin-left:10px;">(y = ${reg.m.toFixed(3)}x + ${reg.b.toFixed(2)}, R¬≤=${reg.r2.toFixed(3)})</span>`;

            const ctx = document.getElementById('corrScatterChart').getContext('2d');
            if (corrScatterChart) corrScatterChart.destroy();

            corrScatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Data Points',
                            data: dataPoints,
                            backgroundColor: 'rgba(0, 120, 168, 0.3)',
                            pointRadius: 2,
                            order: 2 // Draw points below line
                        },
                        {
                            label: 'Trendline',
                            data: trendData,
                            type: 'line',
                            borderColor: '#d7191c',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            tension: 0,
                            order: 1 // Draw line on top
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: xName } },
                        y: { title: { display: true, text: yName } }
                    },
                    plugins: {
                        legend: { labels: { usePointStyle: true } }
                    }
                }
            });
        }

        // --- MAP CHART UTILS ---
        function renderOverviewCharts() {
            document.getElementById('overview-panel').style.display = 'block';
            document.getElementById('station-panel').style.display = 'none';
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;

            const calcAvg = (lvl) => {
                const grp = allData.filter(d => d.sampling_level === lvl && d[param] !== null);
                if(grp.length === 0) return null;
                return grp.reduce((a,b)=>a+b[param],0)/grp.length;
            };
            const lineData = [];
            ['S','M','B'].forEach((l, i) => {
                const val = calcAvg(l);
                if(val!==null) lineData.push({x: val, y: yLabelsOrder[i]});
            });

            const ctxAvg = document.getElementById('avgProfileChart').getContext('2d');
            if (avgProfileChart) avgProfileChart.destroy();
            avgProfileChart = new Chart(ctxAvg, {
                type: 'line',
                data: { labels: yLabelsOrder, datasets: [{ label: 'Average Profile', data: lineData, borderColor: '#28a745', backgroundColor: 'rgba(40,167,69,0.2)', tension: 0.3, pointRadius:5 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { reverse: true, type:'category' }, x:{title:{display:true,text:paramName}} } }
            });

            const scatterData = allData.filter(d => d[param]!==null && d.sampling_depth_m!==null).map(d => ({x:d[param], y:d.sampling_depth_m}));
            const ctxScat = document.getElementById('scatterChart').getContext('2d');
            if (scatterChart) scatterChart.destroy();
            scatterChart = new Chart(ctxScat, {
                type: 'scatter',
                data: { datasets: [{ label: 'All Data', data: scatterData, backgroundColor: 'rgba(0,120,168,0.5)', pointRadius:2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { reverse: true, title:{display:true, text:'Depth (m)'} }, x:{title:{display:true,text:paramName}} } }
            });
        }

        function renderStationProfile(stationName) {
            document.getElementById('overview-panel').style.display = 'none';
            document.getElementById('station-panel').style.display = 'block';
            const param = document.getElementById('paramSelect').value;
            const paramName = document.getElementById('paramSelect').options[document.getElementById('paramSelect').selectedIndex].text;
            const sData = allData.filter(d => d.station===stationName && d[param]!==null);
            
            const ctx = document.getElementById('stationChart').getContext('2d');
            if(stationChart) stationChart.destroy();
            stationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yLabelsOrder,
                    datasets: [{ label: stationName, data: sData.map(d=>({x:d[param], y:levelMap[d.sampling_level]||d.sampling_level})), borderColor: '#0078A8', tension:0.2, fill:false }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { type: 'category', reverse: true, title: { display: true, text: 'Level' } }, x:{title:{display:true,text:paramName}} } }
            });
            document.getElementById('station-info').innerHTML = `üìç <b>${stationName}</b><br>${paramName}`;
        }

        function closeStationView() { renderOverviewCharts(); }

        // Events
        document.getElementById('timeSelect').addEventListener('change', (e) => {
            if(e.target.value) { const [y,m] = e.target.value.split('-'); loadMapData(y, m); }
        });
        document.getElementById('paramSelect').addEventListener('change', () => {
            if(document.getElementById('map-view').classList.contains('active')) {
                renderMapByDepth();
                if(document.getElementById('station-panel').style.display === 'block') renderOverviewCharts();
                else renderOverviewCharts();
            } else {
                loadSummaryData();
            }
        });
        document.getElementById('cruiseSelect').addEventListener('change', () => {
            loadSummaryData();
        });

        initApp();
    </script>
</body>
</html>